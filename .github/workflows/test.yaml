name: Run API Tests

on:
  pull_request:
    branches:
      - main

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r torch-requirements.txt
          pip install pytest
          pip install opencv-python numpy

      - name: Prepare test image and folders
        run: |
          mkdir -p uploads/original uploads/predicted tests
          if [ ! -f tests/test_image.jpg ]; then
            echo "Creating a placeholder test image"
            python -c "import cv2, numpy as np; cv2.imwrite('tests/test_image.jpg', np.zeros((100, 100, 3), dtype=np.uint8))"
          fi

      - name: Run API endpoint tests
        run: |
          pytest tests/test_app.py --disable-warnings -v
